<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B-Buddy Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="dashboard.css">     
</head>

<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">B-Buddy</div>


                <!-- User Info & Avatar -->
                <div class="user-info">
                    <span class="user-name" id="userName">Demo User</span>
                    <div class="user-avatar" id="userAvatar">D</div>

                    <!-- Dropdown Menu -->
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="dropdown-item" id="budgetMenuItem">
                            <span class="dropdown-item-icon">‚öôÔ∏è</span>
                            <span>Budget Settings</span>
                        </div>
                        <div class="dropdown-item danger" id="logoutMenuItem">
                            <span class="dropdown-item-icon">üö™</span>
                            <span>Log Out</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </header>

    <div class="container">
        <div class="dashboard-header">
            <div class="dashboard-title">Financial Dashboard</div>
            <div class="dashboard-subtitle">Track your expenses and manage your budget smartly</div>
        </div>

        <div class="summary-cards">
            <div class="card" id="totalSpentCard">
                <div class="card-title">Total Spent</div>
                <div class="card-value" id="totalSpent">‚Çπ0.00</div>
                <div class="card-subtitle">This month</div>
            </div>
            <div class="card">
                <div class="card-title">Remaining Budget</div>
                <div class="card-value" id="remainingBudget">‚Çπ0.00</div>
                <div class="card-subtitle">Available to spend</div>
            </div>
            <div class="card">
                <div class="card-title">Savings Goal</div>
                <div class="card-value" id="savingsProgress">0%</div>
                <div class="card-subtitle" id="savingsSubtitle">‚Çπ0 of ‚Çπ0</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="savingsBar"></div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="chart-card" id="chartSection">
                <div class="section-title">Spending by Category</div>
                <div class="chart-container" id="chartContainer">
                    <canvas id="spendingChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="section-title">Recent Transactions</div>
                <div class="transactions-list" id="transactionsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No transactions yet. Add your first expense!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="add-expense-btn" id="addExpenseBtn">+</button>

    <div class="modal" id="expenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add New Expense</div>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <form id="expenseForm">
                <div class="form-group">
                    <label class="form-label">Amount (‚Çπ)</label>
                    <input type="number" class="form-input" id="expenseAmount" placeholder="0.00" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="expenseCategory" required>
                        <option value="">Select a category</option>
                        <option value="Food">üçî Food</option>
                        <option value="Transport">üöó Transport</option>
                        <option value="Shopping">üõçÔ∏è Shopping</option>
                        <option value="Entertainment">üéÆ Entertainment</option>
                        <option value="Bills">üí° Bills</option>
                        <option value="Health">üíä Health</option>
                        <option value="Other">üì¶ Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="expenseDescription" placeholder="What did you spend on?"
                        required>
                </div>
                <button type="submit" class="submit-btn">Add Expense</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, onValue, push, set, update } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDMRi-j71wruX5UPFg1kB2pbB99q0Sp9qk",
            authDomain: "b-buddy-4c0a7.firebaseapp.com",
            databaseURL: "https://b-buddy-4c0a7-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "b-buddy-4c0a7",
            storageBucket: "b-buddy-4c0a7.firebasestorage.app",
            messagingSenderId: "1046417860101",
            appId: "1:1046417860101:web:80dd34f12c5dc06dd65e6c",
            measurementId: "G-39M5NFMMMQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let chartInstance = null;
        let isRealUser = false;

        // Demo data for testing
        const demoData = {
            budget: 10000,
            savingsGoal: 5000,
            currentSavings: 0,
            expenses: {}
        };

        // // After user is created successfully in signup process
        // const userRef = firebase.database().ref('users/' + user.uid);
        // userRef.set({
        //     username: username,
        //     email: email,
        //     budget: 10000,  // Default budget
        //     savingsGoal: 5000,  // Default savings goal
        //     currentSavings: 0,  // Starting savings
        //     expenses: {}
        // });

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                isRealUser = true;
                const displayName = user.displayName || user.email.split('@')[0];
                document.getElementById('userName').textContent = displayName;
                document.getElementById('userAvatar').textContent = displayName[0].toUpperCase();
                loadUserData(user.uid);
            } else {
                // Demo mode
                currentUser = { uid: 'demo-user' };
                isRealUser = false;
                updateDashboard(demoData);
            }
        });

        // Load user data from Firebase
        function loadUserData(uid) {
            const userRef = ref(db, `users/${uid}`);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateDashboard(data);
                } else {
                    // Initialize new user with default values
                    const defaultData = {
                        budget: 10000,
                        savingsGoal: 5000,
                        currentSavings: 0,
                        expenses: {}
                    };
                    set(userRef, defaultData);
                    updateDashboard(defaultData);
                }
            });
        }

        // Update dashboard with user data
        function updateDashboard(data) {
            const expenses = data.expenses || {};
            const budget = data.budget || 10000;
            const savingsGoal = data.savingsGoal || 5000;
            const currentSavings = data.currentSavings || 0;

            let totalSpent = 0;
            const categoryTotals = {};
            const transactionsArray = [];

            Object.entries(expenses).forEach(([id, expense]) => {
                totalSpent += parseFloat(expense.amount);
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + parseFloat(expense.amount);
                transactionsArray.push({ id, ...expense });
            });

            document.getElementById('totalSpent').textContent = `‚Çπ${totalSpent.toFixed(2)}`;
            document.getElementById('remainingBudget').textContent = `‚Çπ${(budget - totalSpent).toFixed(2)}`;

            const savingsPercent = Math.min(100, (currentSavings / savingsGoal) * 100);
            document.getElementById('savingsProgress').textContent = `${savingsPercent.toFixed(0)}%`;
            document.getElementById('savingsSubtitle').textContent = `‚Çπ${currentSavings} of ‚Çπ${savingsGoal}`;
            document.getElementById('savingsBar').style.width = `${savingsPercent}%`;

            updateChart(categoryTotals);
            updateTransactionsList(transactionsArray);
        }

        // Update spending chart
        function updateChart(categoryTotals) {
            const ctx = document.getElementById('spendingChart').getContext('2d');
            const categories = Object.keys(categoryTotals);
            const amounts = Object.values(categoryTotals);

            const colors = [
                '#8b85ff', '#a78bfa', '#c084fc', '#e879f9',
                '#f0abfc', '#fbbf24', '#fb923c', '#f87171'
            ];

            if (chartInstance) {
                chartInstance.destroy();
            }

            if (categories.length === 0) {
                return;
            }

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#252938'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: { size: 13 },
                                color: '#a1a1aa',
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1d2e',
                            titleColor: '#fafafa',
                            bodyColor: '#a1a1aa',
                            borderColor: '#3f3f46',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function (context) {
                                    return context.label + ': ‚Çπ' + context.parsed.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update transactions list
        function updateTransactionsList(transactions) {
            const list = document.getElementById('transactionsList');

            if (transactions.length === 0) {
                list.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <p>No transactions yet. Add your first expense!</p>
                </div>
            `;
                return;
            }

            transactions.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            list.innerHTML = transactions.slice(0, 10).map(t => `
            <div class="transaction-item">
                <div class="transaction-info">
                    <div class="transaction-category">${t.category}</div>
                    <div class="transaction-desc">${t.description}</div>
                </div>
                <div class="transaction-amount">‚Çπ${parseFloat(t.amount).toFixed(2)}</div>
            </div>
        `).join('');
        }

        // Modal controls - Expense Modal
        const expenseModal = document.getElementById('expenseModal');
        const addBtn = document.getElementById('addExpenseBtn');
        const closeBtn = document.getElementById('closeModal');

        addBtn.addEventListener('click', () => expenseModal.classList.add('active'));
        closeBtn.addEventListener('click', () => expenseModal.classList.remove('active'));
        expenseModal.addEventListener('click', (e) => {
            if (e.target === expenseModal) expenseModal.classList.remove('active');
        });

        // Modal controls - Budget Modal (NEW)

        const budgetModal = document.getElementById('budgetModal');
        const budgetMenuItem = document.getElementById('budgetMenuItem');
        const closeBudgetBtn = document.getElementById('closeBudgetModal');
        const userDropdown = document.getElementById('userDropdown');
        const userAvatar = document.getElementById('userAvatar');

        // Toggle dropdown on avatar click
        userAvatar.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('active');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!userDropdown.contains(e.target) && !userAvatar.contains(e.target)) {
                userDropdown.classList.remove('active');
            }
        });

        budgetMenuItem.addEventListener('click', () => {
            userDropdown.classList.remove('active');
            if (isRealUser) {
                const userRef = ref(db, `users/${currentUser.uid}`);
                onValue(userRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        document.getElementById('monthlyBudget').value = data.budget || '';
                        document.getElementById('savingsGoalInput').value = data.savingsGoal || '';
                        document.getElementById('currentSavingsInput').value = data.currentSavings || '';
                    }
                }, { onlyOnce: true });
            }
            budgetModal.classList.add('active');
        });

        closeBudgetBtn.addEventListener('click', () => budgetModal.classList.remove('active'));
        budgetModal.addEventListener('click', (e) => {
            if (e.target === budgetModal) budgetModal.classList.remove('active');
        });

        // Logout functionality
        document.getElementById('logoutMenuItem').addEventListener('click', () => {
            userDropdown.classList.remove('active');
            if (isRealUser) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                    alert('Error logging out. Please try again.');
                });
            } else {
                window.location.href = 'index.html';
            }
        });

        // Budget form submission
        document.getElementById('budgetForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const budget = parseFloat(document.getElementById('monthlyBudget').value);
            const savingsGoal = parseFloat(document.getElementById('savingsGoalInput').value);
            const currentSavings = parseFloat(document.getElementById('currentSavingsInput').value);

            if (isRealUser) {
                const userRef = ref(db, `users/${currentUser.uid}`);
                await update(userRef, {
                    budget,
                    savingsGoal,
                    currentSavings
                });
                alert('Budget settings updated successfully!');
            } else {
                demoData.budget = budget;
                demoData.savingsGoal = savingsGoal;
                demoData.currentSavings = currentSavings;
                updateDashboard(demoData);
                alert('Budget settings updated (Demo Mode)');
            }

            budgetModal.classList.remove('active');
        });

        // Add expense form
        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value;

            const expense = {
                amount,
                category,
                description,
                timestamp: Date.now()
            };

            if (isRealUser) {
                const expensesRef = ref(db, `users/${currentUser.uid}/expenses`);
                const newExpenseRef = push(expensesRef);
                await set(newExpenseRef, expense);
            } else {
                const expenseId = 'exp' + Date.now();
                demoData.expenses[expenseId] = expense;
                updateDashboard(demoData);
            }

            e.target.reset();
            expenseModal.classList.remove('active');
        });

        // Scroll to chart
        document.getElementById('totalSpentCard').addEventListener('click', () => {
            document.getElementById('chartSection').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        });

        // Chart click handler
        document.getElementById('chartContainer').addEventListener('click', () => {
            const currentData = isRealUser ? {} : {
                expenses: demoData.expenses,
                budget: demoData.budget
            };
            const dataStr = encodeURIComponent(JSON.stringify(currentData));
            window.open('spending-details.html?data=' + dataStr, '_blank');
        });
    </script>

    <!-- Testing -->
    <!-- Budget Settings Modal -->
    <div class="modal" id="budgetModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Budget Settings</div>
                <button class="close-btn" id="closeBudgetModal">&times;</button>
            </div>
            <form id="budgetForm">
                <div class="form-group">
                    <label class="form-label">Monthly Budget (‚Çπ)</label>
                    <input type="number" class="form-input" id="monthlyBudget" placeholder="15000" step="0.01"
                        required />
                </div>
                <div class="form-group">
                    <label class="form-label">Savings Goal (‚Çπ)</label>
                    <input type="number" class="form-input" id="savingsGoalInput" placeholder="5000" step="0.01"
                        required />
                </div>
                <div class="form-group">
                    <label class="form-label">Current Savings (‚Çπ)</label>
                    <input type="number" class="form-input" id="currentSavingsInput" placeholder="2500" step="0.01"
                        required />
                </div>
                <button type="submit" class="submit-btn">Save Budget</button>
            </form>
        </div>
    </div>
</body>

</html>